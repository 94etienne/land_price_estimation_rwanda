<!DOCTYPE html>
<html>
<head>
    <title>Land Price Estimator & Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f5f5f5; margin:0; padding:0; }

        #sidebar {
            height: 100vh;
            background: #343a40;
            color: white;
            width: 230px;
            position: fixed;
            top: 0; left: 0;
            padding-top: 20px;
        }
        #sidebar a {
            color: #fff; padding: 12px;
            display: block; text-decoration: none;
        }
        #sidebar a:hover { background: #495057; }

        #pageWrapper {
            margin-left: 240px;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }
        #content { flex:1; padding:20px; }
        footer {
            background:#ddd; padding:10px; text-align:center;
            width:100%; font-size:14px;
        }

        .highlight-row { background-color: #e0f7fa !important; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
    <h4 class="text-center">üè° Land System</h4>
    <hr style="border-color:white;">
    <a href="#" onclick="showEstimator()">üîç Price Estimator</a>
    <a href="#" onclick="loadDashboard()">üìä Dashboard</a>
    <a href="#" onclick="loadYears()">üìÖ Future Prices (5 Years)</a>
</div>

<!-- PAGE WRAPPER -->
<div id="pageWrapper">

    <div id="content">
        <h2 id="pageTitle">Land Price Estimator</h2>

        <!-- ===================================================================================
             ESTIMATOR SECTION
        ======================================================================================= -->
        <div id="estimatorSection">
            <div class="card shadow p-4" style="max-width:1000px;">
                <label><strong>Enter UPI:</strong></label>
                <input type="text" id="upiInput" class="form-control" placeholder="3/08/05/01/1234">

                <button class="btn btn-primary w-100 mt-3" onclick="predictPrice()">Estimate Price</button>

                <div id="result" class="mt-4"></div>
            </div>
        </div>


        <!-- ===================================================================================
             DASHBOARD SECTION
        ======================================================================================= -->
        <div id="dashboardSection" style="display:none;">

            <div class="row mb-4">
                <div class="col-md-3"><div class="card shadow p-3"><h6>Total Predictions</h6><h3 id="totalPreds">0</h3></div></div>
                <div class="col-md-3"><div class="card shadow p-3"><h6>Average Price</h6><h4 id="avgPrice">0</h4></div></div>
                <div class="col-md-3"><div class="card shadow p-3"><h6>Highest Price</h6><h4 id="maxPrice">0</h4></div></div>
                <div class="col-md-3"><div class="card shadow p-3"><h6>Lowest Price</h6><h4 id="minPrice">0</h4></div></div>
            </div>

            <h4>Prediction Records</h4>

            <!-- FILTER BAR -->
            <div class="card shadow p-3 mb-3">
                <div class="row g-2">

                    <div class="col-md-2"><input type="text" id="filterUpi" class="form-control" placeholder="Search UPI"></div>

                    <div class="col-md-2"><select id="filterDistrict" class="form-select"><option value="">District</option></select></div>

                    <div class="col-md-2"><select id="filterSector" class="form-select"><option value="">Sector</option></select></div>

                    <div class="col-md-2"><select id="filterLandUse" class="form-select"><option value="">Land Use</option></select></div>

                    <div class="col-md-2"><select id="filterZoning" class="form-select"><option value="">Zoning</option></select></div>

                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">Search</button>
                    </div>

                </div>
            </div>

            <!-- TABLE -->
            <table class="table table-striped table-bordered mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>UPI</th>
                        <th>District</th>
                        <th>Sector</th>
                        <th>Land Use</th>
                        <th>Zoning</th>
                        <th>Area (m¬≤)</th>
                        <th>Predicted Price</th>
                    </tr>
                </thead>
                <tbody id="predTable"></tbody>
            </table>

            <!-- PAGINATION -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button class="btn btn-secondary" onclick="prevPage()">Previous</button>
                <span id="pageInfo" class="fw-bold"></span>
                <button class="btn btn-secondary" onclick="nextPage()">Next</button>
            </div>

        </div>


        <!-- ===================================================================================
             FUTURE YEARS SECTION
        ======================================================================================= -->
        <div id="yearsSection" style="display:none;">

            <!-- <h3 class="mr">5-Year Price Projection</h3> -->

            <div class="card shadow p-4 mb-4" style="max-width:1000px;">
                <label><strong>Enter UPI to View Projection:</strong></label>
                <input type="text" id="yearUpiInput" class="form-control" placeholder="Enter UPI">

                <button class="btn btn-primary w-100 mt-3" onclick="searchUPIProjection()">Search</button>
            </div>

            <!-- CHART AREA -->
            <div id="chartContainer" class="card shadow p-4 mb-4" style="display:none;">
                <h4 id="chartTitle" class="text-center"></h4>
                <canvas id="futureChart" height="120"></canvas>
            </div>

            <!-- TABLE OF FUTURE YEARS -->
            <table class="table table-striped table-bordered mt-3" id="yearsTable" style="display:none;">
                <thead class="table-dark">
                    <tr>
                        <th>UPI</th>
                        <th>Current Price</th>
                        <th>Year 1</th>
                        <th>Year 2</th>
                        <th>Year 3</th>
                        <th>Year 4</th>
                        <th>Year 5</th>
                    </tr>
                </thead>
                <tbody id="futureTableBody"></tbody>
            </table>

        </div>

    </div>

    <footer>
        ¬© 2025 Land Price Prediction System | All Rights Reserved
    </footer>

</div>



<script>
/* ============================================================
    GLOBAL VARIABLES
=============================================================== */
let allRecords = [];
let filteredRecords = [];
let currentPage = 1;
const pageSize = 10;

let chartInstance = null;


/* ============================================================
    SHOW PAGES
=============================================================== */
function showEstimator() {
    hideAll();
    document.getElementById("pageTitle").innerText = "Land Price Estimator";
    document.getElementById("estimatorSection").style.display = "block";
}

function loadDashboard() {
    hideAll();
    document.getElementById("pageTitle").innerInnerText = "Prediction Dashboard";
    document.getElementById("dashboardSection").style.display = "block";
    fetchDashboardData();
}

function loadYears() {
    hideAll();
    document.getElementById("pageTitle").innerText = "Project Future Prices (5 Years)";
    document.getElementById("yearsSection").style.display = "block";

    // Hide chart & table initially
    document.getElementById("chartContainer").style.display = "none";
    document.getElementById("yearsTable").style.display = "none";
}

function hideAll() {
    document.getElementById("estimatorSection").style.display = "none";
    document.getElementById("dashboardSection").style.display = "none";
    document.getElementById("yearsSection").style.display = "none";
}


/* ============================================================
    FETCH PREDICTIONS CSV ‚Üí DASHBOARD
=============================================================== */
async function fetchDashboardData() {
    let res = await fetch("http://127.0.0.1:5000/predictions");
    let data = await res.json();

    allRecords = data.records;
    filteredRecords = [...allRecords];

    loadFilterDropdowns();

    document.getElementById("totalPreds").innerText = data.statistics.total_predictions;
    document.getElementById("avgPrice").innerText = Math.round(data.statistics.avg_price).toLocaleString();
    document.getElementById("maxPrice").innerText = Math.round(data.statistics.max_price).toLocaleString();
    document.getElementById("minPrice").innerText = Math.round(data.statistics.min_price).toLocaleString();

    currentPage = 1;
    renderTable();
}


/* ============================================================
    RENDER TABLE WITH PAGINATION
=============================================================== */
function renderTable() {
    let table = document.getElementById("predTable");
    table.innerHTML = "";

    let start = (currentPage - 1) * pageSize;
    let end = start + pageSize;
    let pageData = filteredRecords.slice(start, end);

    pageData.forEach(row => {
        table.innerHTML += `
            <tr onclick="showFutureFromClick('${row.upi}')" style="cursor:pointer;">
                <td>${row.upi}</td>
                <td>${row.district}</td>
                <td>${row.sector}</td>
                <td>${row.land_use}</td>
                <td>${row.zoning}</td>
                <td>${row.area_m2}</td>
                <td>${Number(row.estimated_price).toLocaleString()}</td>
            </tr>
        `;
    });

    let totalPages = Math.ceil(filteredRecords.length / pageSize);
    document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${totalPages}`;
}

function nextPage() {
    let total = Math.ceil(filteredRecords.length / pageSize);
    if (currentPage < total) { currentPage++; renderTable(); }
}

function prevPage() {
    if (currentPage > 1) { currentPage--; renderTable(); }
}


/* ============================================================
    FILTERS
=============================================================== */
function applyFilters() {
    let upi = document.getElementById("filterUpi").value.toLowerCase();
    let district = document.getElementById("filterDistrict").value;
    let sector = document.getElementById("filterSector").value;
    let land_use = document.getElementById("filterLandUse").value;
    let zoning = document.getElementById("filterZoning").value;

    filteredRecords = allRecords.filter(r =>
        (upi === "" || r.upi.toLowerCase().includes(upi)) &&
        (district === "" || r.district === district) &&
        (sector === "" || r.sector === sector) &&
        (land_use === "" || r.land_use === land_use) &&
        (zoning === "" || r.zoning === zoning)
    );

    currentPage = 1;
    renderTable();
}

function loadFilterDropdowns() {
    fillDropdown("filterDistrict", new Set(allRecords.map(r => r.district)));
    fillDropdown("filterSector", new Set(allRecords.map(r => r.sector)));
    fillDropdown("filterLandUse", new Set(allRecords.map(r => r.land_use)));
    fillDropdown("filterZoning", new Set(allRecords.map(r => r.zoning)));
}

function fillDropdown(id, items) {
    let dropdown = document.getElementById(id);
    let defaultOption = dropdown.options[0].text;
    dropdown.innerHTML = `<option value="">${defaultOption}</option>`;
    items.forEach(v => dropdown.innerHTML += `<option value="${v}">${v}</option>`);
}


/* ============================================================
    CHART + FUTURE YEARS LOGIC
=============================================================== */
function showFutureFromClick(upi) {
    loadYears();
    searchUPIProjection(upi);
}


async function searchUPIProjection(upiArg=null) {

    let upi = upiArg ? upiArg : document.getElementById("yearUpiInput").value.trim();

    if (upi === "") {
        alert("Enter UPI first");
        return;
    }

    // Search in predictions.csv
    let record = allRecords.find(r => r.upi === upi);

    // If not found ‚Üí auto-run prediction API
    if (!record) {
        let res = await fetch(`http://127.0.0.1:5000/predict?upi=${upi}`);
        let data = await res.json();

        if (data.error) {
            alert("UPI does not exist in system.");
            return;
        }

        // Reload predictions.csv after saving
        await fetchDashboardData();

        // Now it exists
        record = allRecords.find(r => r.upi === upi);
    }

    // Compute 5-year projection
    let current = record.estimated_price;
    let growth = 0.08;

    let years = [
        current * Math.pow(1 + growth, 1),
        current * Math.pow(1 + growth, 2),
        current * Math.pow(1 + growth, 3),
        current * Math.pow(1 + growth, 4),
        current * Math.pow(1 + growth, 5)
    ];

    updateFutureTable(upi, current, years);
    plotChart(upi, current, years);
}


function updateFutureTable(upi, current, years) {

    document.getElementById("yearsTable").style.display = "table";

    let tbody = document.getElementById("futureTableBody");
    tbody.innerHTML = `
        <tr>
            <td>${upi}</td>
            <td>${current.toLocaleString()}</td>
            <td>${years[0].toLocaleString()}</td>
            <td>${years[1].toLocaleString()}</td>
            <td>${years[2].toLocaleString()}</td>
            <td>${years[3].toLocaleString()}</td>
            <td>${years[4].toLocaleString()}</td>
        </tr>
    `;
}


function plotChart(upi, current, years) {

    document.getElementById("chartContainer").style.display = "block";
    document.getElementById("chartTitle").innerText = `5-Year Projection for ${upi}`;

    const ctx = document.getElementById("futureChart");

    if (chartInstance) chartInstance.destroy();

    let startYear = new Date().getFullYear();

    chartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: [
                startYear,
                startYear+1,
                startYear+2,
                startYear+3,
                startYear+4,
                startYear+5
            ],
            datasets: [{
                label: "Estimated Price (RWF)",
                data: [current, ...years],
                borderColor: "#007bff",
                backgroundColor: "rgba(0,123,255,0.1)",
                borderWidth: 3,
                tension: 0.2,
                pointRadius: 5
            }]
        }
    });

    document.getElementById("chartContainer").scrollIntoView({ behavior: "smooth" });
}


/* ============================================================
    PRICE ESTIMATOR
=============================================================== */
async function predictPrice() {

    let upi = document.getElementById("upiInput").value;
    if (!upi) return alert("Enter UPI!");

    let resultBox = document.getElementById("result");
    resultBox.innerHTML = "<p class='text-info'>Processing...</p>";

    try {
        let response = await fetch(`http://127.0.0.1:5000/predict?upi=${upi}`);
        let data = await response.json();

        if (data.error) {
            resultBox.innerHTML = `<div class='alert alert-danger'>${data.error}</div>`;
            return;
        }

        resultBox.innerHTML = `
            <div class="row">
                <div class="col-md-7">
                    <div class="card shadow p-3">
                        <h4 class="text-primary">Parcel Details</h4>
                        <table class="table table-bordered">
                            <tr><th>UPI</th><td>${data.upi}</td></tr>
                            <tr><th>District</th><td>${data.district}</td></tr>
                            <tr><th>Sector</th><td>${data.sector}</td></tr>
                            <tr><th>Land Use</th><td>${data.land_use}</td></tr>
                            <tr><th>Zoning</th><td>${data.zoning}</td></tr>
                            <tr><th>Area (m¬≤)</th><td>${data.area_m2}</td></tr>
                            <tr><th>Distance to CBD</th><td>${data.distance_to_cbd_km} km</td></tr>
                            <tr><th>Distance to Road</th><td>${data.distance_to_paved_road_m} m</td></tr>
                            <tr><th>Slope</th><td>${data.slope_deg}¬∞</td></tr>
                            <tr><th>Amenities</th><td>${data.amenities_score}</td></tr>
                        </table>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card shadow p-4 text-center">
                        <h4 class="text-success">Estimated Price</h4>
                        <p class="fs-2 fw-bold">RWF ${data.estimated_price.toLocaleString()}</p>
                        <hr>
                        <h5>Price per m¬≤</h5>
                        <p class="fs-4 fw-bold">RWF ${data.estimated_price_per_m2.toLocaleString()}</p>
                        <button class="btn btn-outline-primary mt-3" onclick="showFutureFromClick('${data.upi}')">
                            View 5-Year Projection
                        </button>
                    </div>
                </div>
            </div>
        `;

    } catch (err) {
        resultBox.innerHTML = "<div class='alert alert-danger'>Failed to connect to server</div>";
    }
}

</script>

</body>
</html>
